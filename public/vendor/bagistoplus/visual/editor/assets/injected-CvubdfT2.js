var H=Object.defineProperty;var k=(y,r,c)=>r in y?H(y,r,{enumerable:!0,configurable:!0,writable:!0,value:c}):y[r]=c;var T=(y,r,c)=>k(y,typeof r!="symbol"?r+"":r,c);var V=function(){const y=()=>{},r={morphStyle:"outerHTML",callbacks:{beforeNodeAdded:y,afterNodeAdded:y,beforeNodeMorphed:y,afterNodeMorphed:y,beforeNodeRemoved:y,afterNodeRemoved:y,beforeAttributeUpdated:y},head:{style:"merge",shouldPreserve:l=>l.getAttribute("im-preserve")==="true",shouldReAppend:l=>l.getAttribute("im-re-append")==="true",shouldRemove:y,afterHeadMorphed:y},restoreFocus:!0};function c(l,S,f={}){l=I(l);const p=N(S),m=D(l,p,f),d=v(m,()=>w(m,l,p,i=>i.morphStyle==="innerHTML"?(b(i,l,p),Array.from(l.childNodes)):h(i,l,p)));return m.pantry.remove(),d}function h(l,S,f){const p=N(S);return b(l,p,f,S,S.nextSibling),Array.from(p.childNodes)}function v(l,S){var n;if(!l.config.restoreFocus)return S();let f=document.activeElement;if(!(f instanceof HTMLInputElement||f instanceof HTMLTextAreaElement))return S();const{id:p,selectionStart:m,selectionEnd:d}=f,i=S();return p&&p!==((n=document.activeElement)==null?void 0:n.id)&&(f=l.target.querySelector(`[id="${p}"]`),f==null||f.focus()),f&&!f.selectionEnd&&d&&f.setSelectionRange(m,d),i}const b=function(){function l(e,t,o,s=null,a=null){t instanceof HTMLTemplateElement&&o instanceof HTMLTemplateElement&&(t=t.content,o=o.content),s||(s=t.firstChild);for(const u of o.childNodes){if(s&&s!=a){const g=f(e,u,s,a);if(g){g!==s&&m(e,s,g),M(g,u,e),s=g.nextSibling;continue}}if(u instanceof Element&&e.persistentIds.has(u.id)){const g=d(t,u.id,s,e);M(g,u,e),s=g.nextSibling;continue}const E=S(t,u,s,e);E&&(s=E.nextSibling)}for(;s&&s!=a;){const u=s;s=s.nextSibling,p(e,u)}}function S(e,t,o,s){if(s.callbacks.beforeNodeAdded(t)===!1)return null;if(s.idMap.has(t)){const a=document.createElement(t.tagName);return e.insertBefore(a,o),M(a,t,s),s.callbacks.afterNodeAdded(a),a}else{const a=document.importNode(t,!0);return e.insertBefore(a,o),s.callbacks.afterNodeAdded(a),a}}const f=function(){function e(s,a,u,E){let g=null,R=a.nextSibling,_=0,O=u;for(;O&&O!=E;){if(o(O,a)){if(t(s,O,a))return O;g===null&&(s.idMap.has(O)||(g=O))}if(g===null&&R&&o(O,R)&&(_++,R=R.nextSibling,_>=2&&(g=void 0)),O.contains(document.activeElement))break;O=O.nextSibling}return g||null}function t(s,a,u){let E=s.idMap.get(a),g=s.idMap.get(u);if(!g||!E)return!1;for(const R of E)if(g.has(R))return!0;return!1}function o(s,a){const u=s,E=a;return u.nodeType===E.nodeType&&u.tagName===E.tagName&&(!u.id||u.id===E.id)}return e}();function p(e,t){var o;if(e.idMap.has(t))n(e.pantry,t,null);else{if(e.callbacks.beforeNodeRemoved(t)===!1)return;(o=t.parentNode)==null||o.removeChild(t),e.callbacks.afterNodeRemoved(t)}}function m(e,t,o){let s=t;for(;s&&s!==o;){let a=s;s=s.nextSibling,p(e,a)}return s}function d(e,t,o,s){const a=s.target.id===t&&s.target||s.target.querySelector(`[id="${t}"]`)||s.pantry.querySelector(`[id="${t}"]`);return i(a,s),n(e,a,o),a}function i(e,t){const o=e.id;for(;e=e.parentNode;){let s=t.idMap.get(e);s&&(s.delete(o),s.size||t.idMap.delete(e))}}function n(e,t,o){if(e.moveBefore)try{e.moveBefore(t,o)}catch{e.insertBefore(t,o)}else e.insertBefore(t,o)}return l}(),M=function(){function l(i,n,e){return e.ignoreActive&&i===document.activeElement?null:(e.callbacks.beforeNodeMorphed(i,n)===!1||(i instanceof HTMLHeadElement&&e.head.ignore||(i instanceof HTMLHeadElement&&e.head.style!=="morph"?C(i,n,e):(S(i,n,e),d(i,e)||b(e,i,n))),e.callbacks.afterNodeMorphed(i,n)),i)}function S(i,n,e){let t=n.nodeType;if(t===1){const o=i,s=n,a=o.attributes,u=s.attributes;for(const E of u)m(E.name,o,"update",e)||o.getAttribute(E.name)!==E.value&&o.setAttribute(E.name,E.value);for(let E=a.length-1;0<=E;E--){const g=a[E];if(g&&!s.hasAttribute(g.name)){if(m(g.name,o,"remove",e))continue;o.removeAttribute(g.name)}}d(o,e)||f(o,s,e)}(t===8||t===3)&&i.nodeValue!==n.nodeValue&&(i.nodeValue=n.nodeValue)}function f(i,n,e){if(i instanceof HTMLInputElement&&n instanceof HTMLInputElement&&n.type!=="file"){let t=n.value,o=i.value;p(i,n,"checked",e),p(i,n,"disabled",e),n.hasAttribute("value")?o!==t&&(m("value",i,"update",e)||(i.setAttribute("value",t),i.value=t)):m("value",i,"remove",e)||(i.value="",i.removeAttribute("value"))}else if(i instanceof HTMLOptionElement&&n instanceof HTMLOptionElement)p(i,n,"selected",e);else if(i instanceof HTMLTextAreaElement&&n instanceof HTMLTextAreaElement){let t=n.value,o=i.value;if(m("value",i,"update",e))return;t!==o&&(i.value=t),i.firstChild&&i.firstChild.nodeValue!==t&&(i.firstChild.nodeValue=t)}}function p(i,n,e,t){const o=n[e],s=i[e];if(o!==s){const a=m(e,i,"update",t);a||(i[e]=n[e]),o?a||i.setAttribute(e,""):m(e,i,"remove",t)||i.removeAttribute(e)}}function m(i,n,e,t){return i==="value"&&t.ignoreActiveValue&&n===document.activeElement?!0:t.callbacks.beforeAttributeUpdated(i,n,e)===!1}function d(i,n){return!!n.ignoreActiveValue&&i===document.activeElement&&i!==document.body}return l}();function w(l,S,f,p){if(l.head.block){const m=S.querySelector("head"),d=f.querySelector("head");if(m&&d){const i=C(m,d,l);return Promise.all(i).then(()=>{const n=Object.assign(l,{head:{block:!1,ignore:!0}});return p(n)})}}return p(l)}function C(l,S,f){let p=[],m=[],d=[],i=[],n=new Map;for(const t of S.children)n.set(t.outerHTML,t);for(const t of l.children){let o=n.has(t.outerHTML),s=f.head.shouldReAppend(t),a=f.head.shouldPreserve(t);o||a?s?m.push(t):(n.delete(t.outerHTML),d.push(t)):f.head.style==="append"?s&&(m.push(t),i.push(t)):f.head.shouldRemove(t)!==!1&&m.push(t)}i.push(...n.values());let e=[];for(const t of i){let o=document.createRange().createContextualFragment(t.outerHTML).firstChild;if(f.callbacks.beforeNodeAdded(o)!==!1){if("href"in o&&o.href||"src"in o&&o.src){let s,a=new Promise(function(u){s=u});o.addEventListener("load",function(){s()}),e.push(a)}l.appendChild(o),f.callbacks.afterNodeAdded(o),p.push(o)}}for(const t of m)f.callbacks.beforeNodeRemoved(t)!==!1&&(l.removeChild(t),f.callbacks.afterNodeRemoved(t));return f.head.afterHeadMorphed(l,{added:p,kept:d,removed:m}),e}const D=function(){function l(n,e,t){const{persistentIds:o,idMap:s}=d(n,e),a=S(t),u=a.morphStyle||"outerHTML";if(!["innerHTML","outerHTML"].includes(u))throw`Do not understand how to morph style ${u}`;return{target:n,newContent:e,config:a,morphStyle:u,ignoreActive:a.ignoreActive,ignoreActiveValue:a.ignoreActiveValue,restoreFocus:a.restoreFocus,idMap:s,persistentIds:o,pantry:f(),callbacks:a.callbacks,head:a.head}}function S(n){let e=Object.assign({},r);return Object.assign(e,n),e.callbacks=Object.assign({},r.callbacks,n.callbacks),e.head=Object.assign({},r.head,n.head),e}function f(){const n=document.createElement("div");return n.hidden=!0,document.body.insertAdjacentElement("afterend",n),n}function p(n){let e=Array.from(n.querySelectorAll("[id]"));return n.id&&e.push(n),e}function m(n,e,t,o){for(const s of o)if(e.has(s.id)){let a=s;for(;a;){let u=n.get(a);if(u==null&&(u=new Set,n.set(a,u)),u.add(s.id),a===t)break;a=a.parentElement}}}function d(n,e){const t=p(n),o=p(e),s=i(t,o);let a=new Map;m(a,s,n,t);const u=e.__idiomorphRoot||e;return m(a,s,u,o),{persistentIds:s,idMap:a}}function i(n,e){let t=new Set,o=new Map;for(const{id:a,tagName:u}of n)o.has(a)?t.add(a):o.set(a,u);let s=new Set;for(const{id:a,tagName:u}of e)s.has(a)?t.add(a):o.get(a)===u&&s.add(a);for(const a of t)s.delete(a);return s}return l}(),{normalizeElement:I,normalizeParent:N}=function(){const l=new WeakSet;function S(d){return d instanceof Document?d.documentElement:d}function f(d){if(d==null)return document.createElement("div");if(typeof d=="string")return f(m(d));if(l.has(d))return d;if(d instanceof Node){if(d.parentNode)return new p(d);{const i=document.createElement("div");return i.append(d),i}}else{const i=document.createElement("div");for(const n of[...d])i.append(n);return i}}class p{constructor(i){this.originalNode=i,this.realParentNode=i.parentNode,this.previousSibling=i.previousSibling,this.nextSibling=i.nextSibling}get childNodes(){const i=[];let n=this.previousSibling?this.previousSibling.nextSibling:this.realParentNode.firstChild;for(;n&&n!=this.nextSibling;)i.push(n),n=n.nextSibling;return i}querySelectorAll(i){return this.childNodes.reduce((n,e)=>{if(e instanceof Element){e.matches(i)&&n.push(e);const t=e.querySelectorAll(i);for(let o=0;o<t.length;o++)n.push(t[o])}return n},[])}insertBefore(i,n){return this.realParentNode.insertBefore(i,n)}moveBefore(i,n){return this.realParentNode.moveBefore(i,n)}get __idiomorphRoot(){return this.originalNode}}function m(d){let i=new DOMParser,n=d.replace(/<svg(\s[^>]*>|>)([\s\S]*?)<\/svg>/gim,"");if(n.match(/<\/html>/)||n.match(/<\/head>/)||n.match(/<\/body>/)){let e=i.parseFromString(d,"text/html");if(n.match(/<\/html>/))return l.add(e),e;{let t=e.firstChild;return t&&l.add(t),t}}else{let t=i.parseFromString("<body><template>"+d+"</template></body>","text/html").body.querySelector("template").content;return l.add(t),t}}return{normalizeElement:S,normalizeParent:f}}();return{morph:c,defaults:r}}();const L={INITIALIZE:"initialize",MOVE_SECTION_UP:"section:move-up",MOVE_SECTION_DOWN:"section:move-down",EDIT_SECTION:"section:edit",TOGGLE_SECTION:"section:toggle",REMOVE_SECTION:"section:remove",SET_USED_COLORS:"usedColors"},A={prefix:"visual:",EDITOR_INITIALIZED:"editor:init",SETTING_UPDATED:"setting:updated",SECTION_HIGHLIGHT:"section:highlight",SECTION_SELECTED:"section:selected",SECTION_REMOVED:"section:removed",CLEAR_ACTIVE_SECTION:"clearActiveSection",SECTIONS_REORDERED:"sectionsOrder",REFRESH_PREVIEW:"refresh",REORDERING:"reordering"};class B{constructor(){T(this,"inDesignMode",!0);T(this,"inPreviewMode",!1)}on(r,c){const h=r.startsWith(A.prefix)?r:A.prefix+r,v=b=>c(b.detail);return document.addEventListener(h,v),()=>document.removeEventListener(h,v)}_dispatch(r,c){const h=A.prefix+r;document.dispatchEvent(new CustomEvent(h,{detail:c}))}handleLiveUpdate(r,c){this.on(A.SETTING_UPDATED,({data:h,skipRefresh:v})=>{var S;const{section:b,block:M,settingId:w,settingValue:C}=h;if(!b||b.type!==r)return;const D=document.querySelector(`[data-section-id="${b.id}"]`);if(!D)return;let I;if(M&&((S=c.blocks)!=null&&S[M.type])?I=c.blocks[M.type][w]:c.section&&(I=c.section[w]),!I)return;const N=I.target?D.querySelector(I.target):null;if(!N)return;const l=typeof I.transform=="function"?I.transform(C):C;typeof I.handler=="function"?I.handler(N,l):I.html?N.innerHTML=l:I.text?N.textContent=l:I.style?N.style[I.style]=l:I.attr&&N.setAttribute(I.attr,l),v()})}}window.Visual=new B;class q{constructor(){T(this,"sectionOverlay");T(this,"sectionLabel");T(this,"moveUpBtn");T(this,"moveDownBtn");T(this,"editBtn");T(this,"disableBtn");T(this,"removeBtn");T(this,"buttonsContainer");T(this,"activeSectionId",null);T(this,"sectionsOrder",[]);T(this,"hoverDebounce",0);T(this,"reorderingSectionId",null);T(this,"messageHandlers",{[A.SECTION_HIGHLIGHT]:r=>this.handleSectionHighlight(r),[A.SECTION_SELECTED]:r=>this.handleSectionSelected(r),[A.SECTION_REMOVED]:r=>this.handleSectionRemoved(r),[A.CLEAR_ACTIVE_SECTION]:()=>this.handleClearActiveSection(),[A.SECTIONS_REORDERED]:r=>this.handleSectionsReordered(r),[A.REORDERING]:r=>this.handleReordering(r),[A.REFRESH_PREVIEW]:r=>this.refreshPreviewer(r),[A.SETTING_UPDATED]:(r,c)=>this.handleSettingUpdated(r,c)})}init(){this.initializeUIElements(),this.attachButtonEvents(),this.attachMouseEvents(),this.postMessage(L.INITIALIZE,{themeData:window.themeData,templates:window.templates,settingsSchema:window.settingsSchema}),this.sectionsOrder=window.themeData.sectionsOrder,window.addEventListener("message",({data:r})=>this.handleMessage(r)),window.addEventListener("resize",()=>this.handleWindowResize()),this.extractUsedColors()}initializeUIElements(){this.sectionOverlay=document.querySelector("#section-overlay"),this.sectionLabel=document.querySelector("#label"),this.buttonsContainer=document.querySelector("#buttons"),this.moveUpBtn=this.sectionOverlay.querySelector("#move-up"),this.moveDownBtn=this.sectionOverlay.querySelector("#move-down"),this.editBtn=this.sectionOverlay.querySelector("#edit"),this.disableBtn=this.sectionOverlay.querySelector("#disable"),this.removeBtn=this.sectionOverlay.querySelector("#remove")}attachButtonEvents(){this.moveUpBtn.onclick=()=>this.postMessage(L.MOVE_SECTION_UP,this.activeSectionId),this.moveDownBtn.onclick=()=>this.postMessage(L.MOVE_SECTION_DOWN,this.activeSectionId),this.editBtn.onclick=()=>this.postMessage(L.EDIT_SECTION,this.activeSectionId),this.disableBtn.onclick=()=>this.postMessage(L.TOGGLE_SECTION,this.activeSectionId),this.removeBtn.onclick=()=>this.postMessage(L.REMOVE_SECTION,this.activeSectionId)}attachMouseEvents(){document.addEventListener("mouseover",r=>{if(!(r.target instanceof Element))return;const c=r.target.closest("[data-section-type]");c&&c.dataset.sectionId!==this.activeSectionId&&(this.buttonsContainer.style.display="flex",this.debounceHighlight(c))},{passive:!0}),document.addEventListener("mouseleave",r=>{if(!(r.target instanceof Element)){this.buttonsContainer.style.display="none",this.clearActiveSection();return}if(!r.target.closest("[data-section-type]"))return;const h=r.relatedTarget;(!h||!this.sectionOverlay.contains(h))&&(this.buttonsContainer.style.display="none",this.clearActiveSection())},{passive:!0})}handleWindowResize(){if(this.activeSectionId){const r=document.querySelector(`[data-section-id="${this.activeSectionId}"]`);r&&this.highlightSection(r)}}debounceHighlight(r){clearTimeout(this.hoverDebounce),this.hoverDebounce=window.setTimeout(()=>{this.highlightSection(r)},50)}handleMessage({type:r,data:c,messageId:h}){const v=this.messageHandlers[r];v?v(c,h):window.Visual._dispatch(r,c)}handleSectionHighlight(r){if(this.reorderingSectionId)return;const c=document.querySelector(`[data-section-id="${r}"]`);c&&(c.scrollIntoView({behavior:"smooth",block:"start"}),c.setAttribute("data-visual-highlighted","true"))}handleSectionSelected(r){if(this.activeSectionId===r)return;const c=document.querySelector(`[data-section-id="${r}"]`);c&&(this.highlightSection(c),c.scrollIntoView({behavior:"smooth",block:"start"}),window.Visual._dispatch(A.SECTION_SELECTED,{section:{id:c.dataset.sectionId,type:c.dataset.sectionType}}))}handleSectionRemoved(r){const c=document.querySelector(`[data-section-id="${r.id}"]`);c&&c.remove()}handleClearActiveSection(){this.clearActiveSection(),document.querySelectorAll("[data-visual-highlighted]").forEach(r=>{r.removeAttribute("data-visual-highlighted")})}handleSectionsReordered(r){this.sectionsOrder=r,this.reorderingSectionId=null,document.querySelectorAll("[data-reordering]").forEach(c=>{c.removeAttribute("data-reordering")})}handleReordering(r){this.reorderingSectionId=r.sectionId,r.order.forEach(h=>{const v=document.querySelector(`[data-section-id="${h}"]`);v!=null&&v.parentElement&&v.parentElement.appendChild(v)});const c=document.querySelector(`[data-section-id="${r.sectionId}"]`);c&&requestAnimationFrame(()=>{c.scrollIntoView({behavior:"smooth",block:"nearest"}),c.dataset.reordering="true"})}handleSettingUpdated(r,c){let h=this.autoHandleLiveUpdate(r);if(h||window.Visual._dispatch(A.SETTING_UPDATED,{data:r,skipRefresh:()=>{h=!0}}),this.activeSectionId){const v=document.querySelector(`[data-section-id="${this.activeSectionId}"]`);v&&this.highlightSection(v)}c&&window.parent.postMessage({messageId:c,skipRefresh:h},window.origin)}highlightSection(r){this.activeSectionId=r.dataset.sectionId;const c=r.getBoundingClientRect();window.requestAnimationFrame(()=>{Object.assign(this.sectionOverlay.style,{display:"block",width:`${c.width}px`,height:`${c.height}px`,left:`${c.left+window.scrollX}px`,top:`${c.top+window.scrollY}px`}),this.sectionLabel.textContent=r.dataset.sectionName||"";const h=this.sectionsOrder.indexOf(this.activeSectionId);this.moveUpBtn.style.display=h>0?"inline":"none",this.moveDownBtn.style.display=h>0&&h<this.sectionsOrder.length-1?"inline":"none"})}clearActiveSection(){this.activeSectionId=null,this.sectionOverlay.style.display="none"}autoHandleLiveUpdate(r){const{section:c,block:h,settingId:v,settingValue:b}=r,M=[c==null?void 0:c.id,h==null?void 0:h.id,v].filter(Boolean).join(":"),w=document.querySelector(`[data-live-update-key="${M}"]`);return w?(w.dataset.liveUpdateAttr?w.setAttribute(w.dataset.liveUpdateAttr,b):w.innerHTML=b,!0):!1}refreshPreviewer(r){const c=new DOMParser().parseFromString(r,"text/html");if(V.morph(document.documentElement,c.documentElement,{callbacks:{beforeNodeMorphed(h,v){var b;return h._x_dataStack&&typeof((b=window.Alpine)==null?void 0:b.morph)=="function"?(window.Alpine.morph(h,v),!1):!0}}}),this.activeSectionId){const h=document.querySelector(`[data-section-id="${this.activeSectionId}"]`);h&&this.highlightSection(h)}}postMessage(r,c){window.parent.postMessage({type:r,data:c},window.origin)}extractUsedColors(r=6){const c=new Map;document.querySelectorAll("*").forEach(v=>{const b=getComputedStyle(v);[b.backgroundColor,b.color].forEach(M=>{M&&M!=="transparent"&&M!=="rgba(0, 0, 0, 0)"&&c.set(M,(c.get(M)||0)+1)})});const h=Array.from(c.entries()).sort((v,b)=>b[1]-v[1]).slice(0,r).map(([v])=>v);this.postMessage(L.SET_USED_COLORS,h)}}window.addEventListener("DOMContentLoaded",()=>{new q().init(),document.dispatchEvent(new CustomEvent(A.prefix+A.EDITOR_INITIALIZED))});
